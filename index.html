<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Calculadora de Escolha de Esta√ß√µes de Energia Pecron</title>
  <style>
    :root{
      --bg:#f3f4f6;
      --card:#ffffff;
      --card2:#fafafa;
      --text:#0f172a;
      --muted:#475569;
      --line:#e5e7eb;

      --yellow:#f6c34b;
      --yellow2:#fff3cd;

      --ok:#16a34a;
      --bad:#dc2626;
      --blue:#2563eb;

      --btn:#111827;
      --btnText:#ffffff;

      --needBg:#fff3cd;
      --needLine:#f6c34b;
    }

    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{max-width:1100px;margin:22px auto;padding:0 14px}

    .hero{
      border-radius:16px;
      background:linear-gradient(180deg, var(--yellow2), rgba(255,243,205,0));
      border:1px solid rgba(246,195,75,.45);
      padding:14px 14px 10px;
      margin-bottom:12px;
    }
    .hero h1{font-size:18px;margin:0}

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
      box-shadow:0 2px 10px rgba(15,23,42,.04);
    }

    .sectionTitle{
      font-weight:900;
      margin:0 0 10px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .sectionTitle:after{
      content:"";
      height:3px;
      flex:1;
      border-radius:99px;
      background:linear-gradient(90deg, var(--yellow), rgba(246,195,75,0));
    }

    .muted{color:var(--muted)}
    select,input{
      background:#fff;border:1px solid var(--line);color:var(--text);
      border-radius:10px;padding:10px
    }
    .hr{height:1px;background:var(--line);margin:12px 0}

    .tableWrap{overflow:auto;border:1px solid var(--line);border-radius:14px}
    .table{width:100%;border-collapse:separate;border-spacing:0;background:#fff}
    .table thead th{
      background:var(--card2);
      border-bottom:1px solid var(--line);
      text-align:left;color:var(--muted);font-weight:800;font-size:12px;
      padding:10px;
      position:sticky;top:0;
    }
    .table td{
      padding:10px;border-bottom:1px solid var(--line);vertical-align:middle
    }
    .table td.right{text-align:right}
    .table tr:last-child td{border-bottom:none}

    .btn{
      background:var(--btn);border:1px solid var(--btn);
      color:var(--btnText);border-radius:12px;padding:10px 12px;cursor:pointer
    }
    .btn:hover{filter:brightness(.95)}
    .btn:disabled{opacity:.55;cursor:not-allowed}

    .iconBtn{
      width:38px;height:38px;border-radius:10px;border:1px solid var(--line);
      background:#fff;cursor:pointer;color:var(--text)
    }
    .iconBtn:hover{background:var(--card2)}
    .iconBtn:disabled{opacity:.40;cursor:not-allowed}

    .totals{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    @media (min-width:920px){.totals{grid-template-columns:repeat(4,1fr)}}

    .kpi{
      background:linear-gradient(180deg, rgba(246,195,75,.10), rgba(246,195,75,0));
      border:1px solid rgba(246,195,75,.35);
      border-radius:14px;
      padding:10px
    }
    .kpi .t{color:var(--muted);font-weight:700;font-size:12px}
    .kpi .v{font-size:18px;font-weight:900;margin-top:2px}

    .cfg{
      background:#eef2f7;
      border:1px solid var(--line);
      border-radius:14px;padding:10px
    }
    .cfg .title{color:var(--muted);font-size:12px;font-weight:800}
    .pill{
      display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);
      border-radius:999px;padding:8px 10px;background:#fff
    }

    .msg{margin-top:10px;padding:10px;border-radius:14px;border:1px solid var(--line);background:#fff}
    .msg.bad{border-color:rgba(220,38,38,.28)}
    .msg.ok{border-color:rgba(22,163,74,.28)}

    .cards{display:grid;grid-template-columns:1fr;gap:10px}
    @media (min-width:720px){.cards{grid-template-columns:repeat(3,1fr)}}
    .mcard{border:1px solid var(--line);border-radius:16px;padding:12px;background:#fff}
    .mhead{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .tag{font-size:12px;font-weight:900;padding:4px 8px;border-radius:999px;border:1px solid var(--line)}
    .tag.rec{color:var(--ok);border-color:rgba(22,163,74,.25);background:rgba(22,163,74,.07)}
    .tag.ok{color:var(--blue);border-color:rgba(37,99,235,.25);background:rgba(37,99,235,.07)}
    .tag.bad{color:var(--bad);border-color:rgba(220,38,38,.25);background:rgba(220,38,38,.07)}
    .small{font-size:12px}
    ul{margin:8px 0 0 18px;padding:0}

    /* campos que precisam preencher */
    .need{
      background:var(--needBg)!important;
      border-color:var(--needLine)!important;
      box-shadow:0 0 0 3px rgba(246,195,75,.20)
    }

    /* relat√≥rio (card separado no final) */
    .reportKpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
    .rkpi{
      background:#fff;
      border:1px solid rgba(246,195,75,.35);
      border-radius:14px;
      padding:10px;
    }
    .rkpi .t{color:var(--muted);font-weight:800;font-size:12px}
    .rkpi .v{font-size:18px;font-weight:900;margin-top:2px}
    .rtableWrap{
      margin-top:10px;
      overflow:auto;
      border:1px solid rgba(15,23,42,.08);
      border-radius:14px;
      background:#fff;
    }
    .rtable{width:100%;border-collapse:separate;border-spacing:0}
    .rtable th,.rtable td{padding:10px;border-bottom:1px solid rgba(15,23,42,.08);font-size:12px}
    .rtable th{color:var(--muted);font-weight:900;background:#fbfbfb;text-align:left}
    .rtable td.right{text-align:right}
    .rtable tr:last-child td{border-bottom:none}
  </style>
</head>
<body>
<div class="wrap">
  <div class="hero">
    <h1>Calculadora de Escolha de Esta√ß√µes de Energia Pecron</h1>
  </div>

  <!-- FERRAMENTA -->
  <div class="card">
    <div class="sectionTitle">Cargas</div>

    <div class="tableWrap">
      <table class="table">
        <thead>
          <tr>
            <th style="min-width:280px">Carga</th>
            <th class="right">Pot√™ncia (W)</th>
            <th class="right">Qtd</th>
            <th class="right">Tempo (h)</th>
            <th class="right">Consumo (Wh)</th>
            <th class="right">Pico total (W)</th>
            <th class="right">A√ß√£o</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="hr"></div>

    <div class="totals">
      <div class="kpi">
        <div class="t">Pot√™ncia total</div>
        <div class="v" id="kpiW">0 W</div>
      </div>
      <div class="kpi">
        <div class="t">Consumo total</div>
        <div class="v" id="kpiWh">0 Wh</div>
      </div>
      <div class="kpi">
        <div class="t">Pot√™ncia pico total</div>
        <div class="v" id="kpiPk">0 W</div>
      </div>

      <div class="cfg">
        <div class="title">Uso</div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:6px">
          <label class="pill" style="margin:0;cursor:pointer">
            <input type="radio" name="modo" value="S" checked>
            <span><b>Uso espor√°dico</b> <span class="muted small">(DoD 90%)</span></span>
          </label>
          <label class="pill" style="margin:0;cursor:pointer">
            <input type="radio" name="modo" value="D">
            <span><b>Uso di√°rio</b> <span class="muted small">(DoD 80%)</span></span>
          </label>
        </div>
      </div>
    </div>

    <div id="msg" class="msg" style="display:none"></div>

    <div style="display:flex;justify-content:flex-end;margin-top:12px">
      <button id="btnCalc" class="btn">Calcular</button>
    </div>
  </div>

  <!-- RELAT√ìRIO (NO FINAL, ANTES DOS CARDS) -->
  <div id="reportCard" class="card" style="margin-top:12px;display:none">
    <div class="sectionTitle">Relat√≥rio do c√°lculo</div>
    <div class="muted" id="reportMeta" style="font-size:12px"></div>

    <div class="reportKpis">
      <div class="rkpi">
        <div class="t">Pot√™ncia total</div>
        <div class="v" id="rTotW">0 W</div>
      </div>
      <div class="rkpi">
        <div class="t">Consumo total</div>
        <div class="v" id="rTotWh">0 Wh</div>
      </div>
      <div class="rkpi">
        <div class="t">Pot√™ncia pico total</div>
        <div class="v" id="rTotPk">0 W</div>
      </div>
    </div>

    <div class="rtableWrap">
      <table class="rtable">
        <thead>
          <tr>
            <th>Carga</th>
            <th class="right">Pot√™ncia (W)</th>
            <th class="right">Qtd</th>
            <th class="right">Tempo (h)</th>
            <th class="right">Consumo (Wh)</th>
            <th class="right">Pico (W)</th>
          </tr>
        </thead>
        <tbody id="reportBody"></tbody>
      </table>
    </div>
  </div>

  <!-- MODELOS -->
  <div id="modelsSection" class="card" style="margin-top:12px;display:none">
    <div class="sectionTitle">Modelos compat√≠veis</div>
    <div class="cards" id="cards"></div>
  </div>
</div>

<script>
const PRESETS = [
  {name:'L√¢mpada LED 9W', power:9, pico:1},
  {name:'Celular', power:30, pico:1},
  {name:'Notebook', power:60, pico:1},
  {name:'Drone', power:40, pico:1},
  {name:'Projetor', power:65, pico:1},
  {name:'Som', power:50, pico:1},
  {name:'Roteador e Modem', power:20, pico:1},
  {name:'Starlink Mini', power:24, pico:1},
  {name:'Ventilador', power:80, pico:4},
  {name:'Geladeira 300L', power:120, pico:5},
  {name:'Geladeira 350L', power:180, pico:5},
  {name:'Freezer 300L', power:180, pico:5},
  {name:'Geladeria Port√°til 30L', power:45, pico:5},
  {name:'Geladeria Port√°til 50L', power:70, pico:5},
  {name:"TV LED 42'", power:120, pico:1},
];

const MODELOS = [
  {name:'P500', V:12.8, Ah:36, eff:0.85, contW:500, peakW:700},
  {name:'E1000', V:51.2, Ah:20, eff:0.85, contW:1800, peakW:3000},
  {name:'E2400', V:51.2, Ah:40, eff:0.85, contW:2400, peakW:4000},
];

const DoD = { S: 0.9, D: 0.8 };

const tbody = document.getElementById('tbody');
const btnCalc = document.getElementById('btnCalc');
const cards = document.getElementById('cards');
const modelsSection = document.getElementById('modelsSection');

const kpiW = document.getElementById('kpiW');
const kpiWh = document.getElementById('kpiWh');
const kpiPk = document.getElementById('kpiPk');
const msg = document.getElementById('msg');

const reportCard = document.getElementById('reportCard');
const reportBody = document.getElementById('reportBody');
const reportMeta = document.getElementById('reportMeta');
const rTotW = document.getElementById('rTotW');
const rTotWh = document.getElementById('rTotWh');
const rTotPk = document.getElementById('rTotPk');

function fmt(n, dec=0){
  if (!isFinite(n)) return '‚Äî';
  return n.toLocaleString('pt-BR', {minimumFractionDigits:dec, maximumFractionDigits:dec});
}
function getModo(){ return document.querySelector('input[name="modo"]:checked').value; }
function showMsg(text, kind='bad'){
  msg.textContent = text;
  msg.className = 'msg ' + (kind === 'ok' ? 'ok' : 'bad');
  msg.style.display = 'block';
}
function hideMsg(){ msg.style.display = 'none'; msg.textContent = ''; }

function parseHorasBR(v){
  if (!v) return 0;
  const raw = String(v).trim();
  const s = raw.includes(',') ? raw.replace(/\./g,'').replace(',', '.') : raw;
  const n = parseFloat(s);
  return isFinite(n) && n > 0 ? n : 0;
}
function formatHorasBR(hours, dec=2){
  if (!isFinite(hours)) return '';
  let s = hours.toFixed(dec).replace('.', ',');
  s = s.replace(/,?0+$/,'').replace(/,$/,',0');
  return (s === '0' || s === '0,0') ? '' : s;
}
function parseQtd(v){
  if (!v) return 0;
  const s = String(v).trim().replace(/\D+/g,'');
  const n = parseInt(s || '0', 10);
  return isFinite(n) && n > 0 ? n : 0;
}
function floor5MinutesFromHours(hours){
  const mins = Math.floor(Math.max(0, hours) * 60);
  return Math.floor(mins / 5) * 5; // sempre pra baixo
}
function floor5Minutes(mins){
  mins = Math.floor(Math.max(0, mins));
  return Math.floor(mins / 5) * 5; // sempre pra baixo
}

function buildPresetSelect(el){
  el.innerHTML = '';
  const opt0 = document.createElement('option');
  opt0.value = '';
  opt0.textContent = 'Selecione...';
  el.appendChild(opt0);

  for (let i=0;i<PRESETS.length;i++){
    const p = PRESETS[i];
    const opt = document.createElement('option');
    opt.value = String(i);
    opt.textContent = p.name;
    el.appendChild(opt);
  }
}

function rowIsValid(tr){
  const idxStr = tr.querySelector('.cargaSel').value;
  const qty = parseQtd(tr.querySelector('.qty').value || '');
  const horas = parseHorasBR(tr.querySelector('.horas').value || '');
  return idxStr !== '' && qty > 0 && horas > 0;
}

function refreshNeedHighlight(tr){
  const sel = tr.querySelector('.cargaSel');
  const qtyEl = tr.querySelector('.qty');
  const hEl = tr.querySelector('.horas');

  const hasCarga = (sel.value !== '');
  const qty = parseQtd(qtyEl.value || '');
  const horas = parseHorasBR(hEl.value || '');

  if (!hasCarga) sel.classList.add('need'); else sel.classList.remove('need');
  if (qty <= 0) qtyEl.classList.add('need'); else qtyEl.classList.remove('need');
  if (horas <= 0) hEl.classList.add('need'); else hEl.classList.remove('need');
}

function updateActionButtons(){
  const rows = Array.from(tbody.querySelectorAll('tr'));
  rows.forEach((tr, idx) => {
    const plus = tr.querySelector('.btnPlus');
    const isLast = idx === rows.length - 1;
    plus.style.visibility = isLast ? 'visible' : 'hidden';
    plus.disabled = !(isLast && rowIsValid(tr));
  });
}

function recalcPreviewTotals(){
  let totW = 0, totWh = 0, totPk = 0;

  const rows = Array.from(tbody.querySelectorAll('tr'));
  for (const tr of rows){
    const idxStr = tr.querySelector('.cargaSel').value;
    const p = idxStr === '' ? null : PRESETS[parseInt(idxStr,10)];
    const qty = parseQtd(tr.querySelector('.qty').value || '');
    const horas = parseHorasBR(tr.querySelector('.horas').value || '');

    refreshNeedHighlight(tr);

    if (!p){
      tr.querySelector('.pot').textContent = '0';
      tr.querySelector('.consumo').textContent = '0';
      tr.querySelector('.picoTot').textContent = '0';
      continue;
    }

    tr.querySelector('.pot').textContent = fmt(p.power,0);

    if (qty <= 0 || horas <= 0){
      tr.querySelector('.consumo').textContent = '0';
      tr.querySelector('.picoTot').textContent = '0';
      continue;
    }

    const mins = floor5MinutesFromHours(horas);
    const horasAdj = mins / 60;

    const w = p.power * qty;
    const wh = w * horasAdj;
    const pk = w * p.pico;

    tr.querySelector('.consumo').textContent = fmt(wh,0);
    tr.querySelector('.picoTot').textContent = fmt(pk,0);

    totW += w; totWh += wh; totPk += pk;
  }

  kpiW.textContent = `${fmt(totW,0)} W`;
  kpiWh.textContent = `${fmt(totWh,0)} Wh`;
  kpiPk.textContent = `${fmt(totPk,0)} W`;

  updateActionButtons();
}

function makeRowBlank(){
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><select class="cargaSel need" style="width:100%"></select></td>
    <td class="right"><span class="pot">0</span></td>
    <td class="right"><input class="qty need" type="text" inputmode="numeric" value=""></td>
    <td class="right"><input class="horas need" type="text" inputmode="decimal" value=""></td>
    <td class="right"><span class="consumo">0</span></td>
    <td class="right"><span class="picoTot">0</span></td>
    <td class="right" style="white-space:nowrap">
      <button class="iconBtn btnPlus" title="Adicionar nova linha">Ôºã</button>
      <button class="iconBtn btnDel" title="Remover linha">üóë</button>
    </td>
  `;

  const sel = tr.querySelector('.cargaSel');
  const qty = tr.querySelector('.qty');
  const horas = tr.querySelector('.horas');
  const btnPlus = tr.querySelector('.btnPlus');
  const btnDel = tr.querySelector('.btnDel');

  buildPresetSelect(sel);

  sel.addEventListener('change', () => { hideMsg(); recalcPreviewTotals(); });

  qty.addEventListener('input', () => {
    hideMsg();
    const cleaned = String(qty.value || '').replace(/\D+/g,'');
    if (qty.value !== cleaned) qty.value = cleaned;
    recalcPreviewTotals();
  });

  horas.addEventListener('input', () => {
    hideMsg();
    const cleaned = String(horas.value || '').replace(/[^0-9,\.]/g,'');
    if (horas.value !== cleaned) horas.value = cleaned;
    recalcPreviewTotals();
  });

  horas.addEventListener('blur', () => {
    const h = parseHorasBR(horas.value || '');
    const mins = floor5MinutesFromHours(h);
    const hAdj = mins / 60;
    horas.value = hAdj > 0 ? formatHorasBR(hAdj, 2) : '';
    hideMsg();
    recalcPreviewTotals();
  });

  btnPlus.addEventListener('click', () => {
    hideMsg();
    const rows = Array.from(tbody.querySelectorAll('tr'));
    if (rows[rows.length - 1] !== tr) return;
    if (!rowIsValid(tr)){
      showMsg('Preencha carga, Qtd e Tempo (h) antes de adicionar nova linha.');
      return;
    }
    tbody.appendChild(makeRowBlank());
    recalcPreviewTotals();
  });

  btnDel.addEventListener('click', () => {
    tr.remove();
    hideMsg();
    recalcPreviewTotals();
    modelsSection.style.display = 'none';
    cards.innerHTML = '';
    if (tbody.querySelectorAll('tr').length === 0){
      tbody.appendChild(makeRowBlank());
      recalcPreviewTotals();
    }
  });

  return tr;
}

function collectRowsValidated(){
  const rows = Array.from(tbody.querySelectorAll('tr'));
  const items = [];

  for (let i=0;i<rows.length;i++){
    const tr = rows[i];
    const idxStr = tr.querySelector('.cargaSel').value;
    const qty = parseQtd(tr.querySelector('.qty').value || '');
    const h = parseHorasBR(tr.querySelector('.horas').value || '');

    const isBlank = (idxStr === '' && qty <= 0 && h <= 0);
    const isValid = (idxStr !== '' && qty > 0 && h > 0);
    const isPartial = !isBlank && !isValid;

    if (isPartial) return { ok:false, error:`Linha ${i+1} incompleta: selecione a carga e preencha Qtd e Tempo (h).` };

    if (isBlank){
      for (let j=i+1;j<rows.length;j++){
        const tr2 = rows[j];
        const idx2 = tr2.querySelector('.cargaSel').value;
        const q2 = parseQtd(tr2.querySelector('.qty').value || '');
        const h2 = parseHorasBR(tr2.querySelector('.horas').value || '');
        if (idx2 !== '' || q2 > 0 || h2 > 0) return { ok:false, error:`H√° uma linha preenchida ap√≥s uma linha em branco (linha ${j+1}).` };
      }
      break;
    }

    const p = PRESETS[parseInt(idxStr,10)];
    const mins = floor5MinutesFromHours(h);
    const horasAdj = mins / 60;

    tr.querySelector('.horas').value = horasAdj > 0 ? formatHorasBR(horasAdj, 2) : '';
    tr.querySelector('.qty').value = String(qty);

    const w = p.power * qty;
    const wh = w * horasAdj;
    const pk = w * p.pico;

    items.push({ name:p.name, power:p.power, pico:p.pico, qty, horas:horasAdj, w, wh, pk });
  }

  if (items.length === 0) return { ok:false, error:'Adicione ao menos uma carga.' };
  return { ok:true, items };
}

function calcTotals(items){
  let totW = 0, totWh = 0, totPk = 0;
  for (const it of items){
    totW += it.w;
    totWh += it.wh;
    totPk += it.pk;
  }
  return { totW, totWh, totPk };
}

function modelEnergyNominalWh(m){ return m.V * m.Ah; }
function modelEnergyUsefulWh(m, modo){ return modelEnergyNominalWh(m) * m.eff * DoD[modo]; }

function plural(n, s, p){ return n === 1 ? s : p; }

function minutesToLongText(mins){
  mins = floor5Minutes(mins);
  const d = Math.floor(mins / (24*60));
  mins -= d*24*60;
  const h = Math.floor(mins / 60);
  const m = mins % 60;

  const parts = [];
  if (d > 0) parts.push(`${d} ${plural(d,'dia','dias')}`);
  if (h > 0) parts.push(`${h} ${plural(h,'hora','horas')}`);
  parts.push(`${m} ${plural(m,'minuto','minutos')}`);

  if (parts.length === 1) return parts[0];
  if (parts.length === 2) return parts[0] + ' e ' + parts[1];
  return parts[0] + ' ' + parts[1] + ' e ' + parts[2];
}

function renderReport(items, totals){
  reportBody.innerHTML = '';
  for (const it of items){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${it.name}</td>
      <td class="right">${fmt(it.power,0)}</td>
      <td class="right">${fmt(it.qty,0)}</td>
      <td class="right">${fmt(it.horas,2)}</td>
      <td class="right">${fmt(it.wh,0)}</td>
      <td class="right">${fmt(it.pk,0)}</td>
    `;
    reportBody.appendChild(tr);
  }

  const now = new Date();
  reportMeta.textContent = `Gerado em ${now.toLocaleDateString('pt-BR')} ${now.toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'})}`;

  rTotW.textContent = `${fmt(totals.totW,0)} W`;
  rTotWh.textContent = `${fmt(totals.totWh,0)} Wh`;
  rTotPk.textContent = `${fmt(totals.totPk,0)} W`;

  reportCard.style.display = 'block';
}

function renderCards(results){
  cards.innerHTML = '';
  for (const r of results){
    const div = document.createElement('div');
    div.className = 'mcard';
    const tagClass = r.recommended ? 'rec' : (r.compat ? 'ok' : 'bad');
    const tagText = r.recommended ? 'Recomendado' : (r.compat ? 'Compat√≠vel' : 'N√£o compat√≠vel');

    div.innerHTML = `
      <div class="mhead">
        <div style="font-weight:900;font-size:14px">${r.name}</div>
        <span class="tag ${tagClass}">${tagText}</span>
      </div>
      <div class="small muted">
        Pot√™ncia: ${fmt(r.contW,0)} W ‚Ä¢ Pico: ${fmt(r.peakW,0)} W ‚Ä¢ Energia: ${fmt(r.energyNominalWh,0)} Wh
      </div>
      <div class="small" style="margin-top:8px">
        <div><span class="muted">Autonomia:</span> <b>${r.compat ? r.autonomyText : '‚Äî'}</b></div>
      </div>
    `;

    if (!r.compat){
      const ul = document.createElement('ul');
      for (const reason of r.reasons){
        const li = document.createElement('li');
        li.textContent = reason;
        ul.appendChild(li);
      }
      div.appendChild(ul);
    }

    cards.appendChild(div);
  }
}

function resetInputsForNewCalc(){
  tbody.innerHTML = '';
  tbody.appendChild(makeRowBlank());
  recalcPreviewTotals();
}

btnCalc.addEventListener('click', () => {
  hideMsg();

  const got = collectRowsValidated();
  if (!got.ok){
    showMsg(got.error, 'bad');
    modelsSection.style.display = 'none';
    cards.innerHTML = '';
    return;
  }

  const modo = getModo();
  const totals = calcTotals(got.items);

  // relat√≥rio (no final)
  renderReport(got.items, totals);

  // calcula compatibilidade + autonomia (autonomia s√≥ se compat√≠vel)
  const tmp = MODELOS.map(m => {
    const energyNominalWh = modelEnergyNominalWh(m);
    const energyUsefulWh = modelEnergyUsefulWh(m, modo);

    const passW = totals.totW <= m.contW + 1e-9;
    const passPk = totals.totPk <= m.peakW + 1e-9;
    const passE = totals.totWh <= energyUsefulWh + 1e-9;

    const compat = passW && passPk && passE;

    const reasons = [];
    if (!passW) reasons.push(`Excede pot√™ncia em ${fmt(totals.totW - m.contW,0)} W`);
    if (!passPk) reasons.push(`Excede pico em ${fmt(totals.totPk - m.peakW,0)} W`);
    if (!passE) reasons.push(`Energia insuficiente: falta ${fmt(totals.totWh - energyUsefulWh,0)} Wh`);

    let autonomyText = '';
    if (compat){
      const ratio = (totals.totWh > 0) ? (energyUsefulWh / totals.totWh) : Infinity;
      const minutes = isFinite(ratio) ? (ratio * 24 * 60) : 999999999;
      autonomyText = (totals.totWh <= 0) ? '‚àû' : minutesToLongText(minutes);
    }

    return { name:m.name, contW:m.contW, peakW:m.peakW, energyNominalWh, compat, reasons, autonomyText };
  });

  // recomenda sempre a menor compat√≠vel (menor energia nominal; desempate por pot√™ncia cont√≠nua)
  const compatibles = tmp.filter(x => x.compat);
  let recommendedName = '';
  if (compatibles.length){
    compatibles.sort((a,b) => (a.energyNominalWh - b.energyNominalWh) || (a.contW - b.contW));
    recommendedName = compatibles[0].name;
  }

  const results = tmp.map(x => ({...x, recommended: (x.compat && x.name === recommendedName)}));

  modelsSection.style.display = 'block';
  renderCards(results);

  if (!results.some(r => r.compat)) showMsg('Nenhum modelo ficou compat√≠vel.', 'bad');
  else showMsg('C√°lculo conclu√≠do.', 'ok');

  // limpa as cargas para novo c√°lculo
  resetInputsForNewCalc();
});

function init(){
  tbody.innerHTML = '';
  tbody.appendChild(makeRowBlank());
  recalcPreviewTotals();
}
init();
</script>
</body>
</html>
