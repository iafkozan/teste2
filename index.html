<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Calculadora de Escolha de Esta√ß√µes de Energia Pecron</title>
  <style>
    :root{
      --bg:#f3f4f6;
      --card:#ffffff;
      --card2:#fafafa;
      --text:#0f172a;
      --muted:#475569;
      --line:#e5e7eb;

      --yellow:#f6c34b;
      --yellow2:#fff3cd;

      --ok:#16a34a;
      --bad:#dc2626;
      --blue:#2563eb;

      --btn:#111827;
      --btnText:#ffffff;

      --needBg:#fff3cd;
      --needLine:#f6c34b;
    }

    *{box-sizing:border-box}
    body{
      margin:0;background:var(--bg);color:var(--text);
      font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Arial;
      overflow-x:hidden;
    }
    .wrap{max-width:1100px;margin:16px auto;padding:0 12px}

    .hero{
      border-radius:16px;
      background:linear-gradient(180deg, var(--yellow2), rgba(255,243,205,0));
      border:1px solid rgba(246,195,75,.45);
      padding:12px 14px;
      margin-bottom:10px;
    }
    .hero h1{font-size:18px;margin:0}

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
      box-shadow:0 2px 10px rgba(15,23,42,.04);
    }

    .sectionTitle{
      font-weight:900;
      margin:0 0 10px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .sectionTitle:after{
      content:"";
      height:3px;
      flex:1;
      border-radius:99px;
      background:linear-gradient(90deg, var(--yellow), rgba(246,195,75,0));
    }

    select,
    input[type="text"]{
      background:#fff;border:1px solid var(--line);color:var(--text);
      border-radius:12px;
      padding:9px 10px;
      min-height:38px;
      font-size:14px;
      width:100%;
    }

    input[type="radio"]{
      width:auto;height:auto;margin:0;transform:none;accent-color:auto;
    }

    .hr{height:2px;background:rgba(15,23,42,.08);margin:10px 0}

    .tableWrap{
      border:1px solid var(--line);
      border-radius:14px;
      background:#fff;
      overflow:hidden;
    }

    table{width:100%;border-collapse:separate;border-spacing:0;table-layout:fixed}
    thead th{
      background:var(--card2);
      border-bottom:1px solid var(--line);
      text-align:left;color:var(--muted);font-weight:800;font-size:12px;
      padding:10px;
      position:sticky;top:0;
      z-index:1;
      white-space:nowrap;
    }
    td{
      padding:10px;border-bottom:1px solid var(--line);vertical-align:middle;
      overflow:hidden;
    }
    td.right{text-align:right}
    tbody tr:last-child td{border-bottom:none}

    /* ===== PC: todas as colunas (exceto Carga) MESMA largura =====
       1) Carga fixa em px
       2) as 6 demais colunas iguais via calc((100% - carga)/6) */
    col.c1{width:320px;}
    col.c2, col.c3, col.c4, col.c5, col.c6, col.c7{width:calc((100% - 320px)/6);}

    @media (max-width: 1100px){
      col.c1{width:280px;}
      col.c2, col.c3, col.c4, col.c5, col.c6, col.c7{width:calc((100% - 280px)/6);}
    }
    @media (max-width: 1024px){
      col.c1{width:240px;}
      col.c2, col.c3, col.c4, col.c5, col.c6, col.c7{width:calc((100% - 240px)/6);}
    }

    .btn{
      background:var(--btn);border:1px solid var(--btn);
      color:var(--btnText);border-radius:12px;padding:10px 14px;
      cursor:pointer;min-height:40px;font-weight:800
    }
    .btn:hover{filter:brightness(.95)}
    .btn:disabled{opacity:.55;cursor:not-allowed}

    .btnGhost{
      background:#fff;border:1px solid var(--line);
      color:var(--text);border-radius:12px;padding:10px 14px;
      cursor:pointer;min-height:40px;font-weight:800
    }
    .btnGhost:hover{background:var(--card2)}

    .iconBtn{
      width:34px;height:34px;border-radius:12px;border:1px solid var(--line);
      background:#fff;cursor:pointer;color:var(--text);font-size:18px;
      display:inline-flex;align-items:center;justify-content:center;
      flex:0 0 auto;
    }
    .iconBtn:hover{background:var(--card2)}
    .iconBtn:disabled{opacity:.40;cursor:not-allowed}

    .actionsRow{
      display:flex;
      gap:6px;
      justify-content:flex-end;
      align-items:center;
      width:100%;
    }

    .totals{
      display:grid;
      grid-template-columns:repeat(12, 1fr);
      gap:8px;
      align-items:stretch;
    }

    .kpi, .cfg{
      border-radius:12px;
      padding:10px 12px;
      min-height:78px;
    }

    .kpi{
      background:linear-gradient(180deg, rgba(246,195,75,.09), rgba(246,195,75,0));
      border:1px solid rgba(246,195,75,.32);
    }
    .kpi .t{color:var(--muted);font-weight:900;font-size:11px}
    .kpi .v{font-size:16px;font-weight:900;margin-top:2px}

    .cfg{
      background:#eef2f7;
      border:1px solid var(--line);
    }
    .cfg .title{color:var(--muted);font-size:11px;font-weight:900;margin-bottom:8px}

    .pillRow{display:flex;gap:8px;flex-wrap:nowrap}
    .pill{
      display:flex;align-items:center;gap:10px;
      border:1px solid var(--line);
      border-radius:999px;
      padding:8px 10px;
      background:#fff;
      min-height:38px;
      margin:0;
      cursor:pointer;
      flex:1;
    }
    .pill span{font-size:13px}

    .k1{grid-column:span 2}
    .k2{grid-column:span 2}
    .k3{grid-column:span 2}
    .u1{grid-column:span 6}

    .msg{
      margin-top:8px;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      font-size:13px;
    }
    .msg.bad{border-color:rgba(220,38,38,.28)}
    .msg.ok{border-color:rgba(22,163,74,.28)}

    .cards{display:grid;grid-template-columns:1fr;gap:10px}
    @media (min-width:720px){.cards{grid-template-columns:repeat(3,1fr)}}
    .mcard{border:1px solid var(--line);border-radius:16px;padding:12px;background:#fff}
    .mhead{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .tag{font-size:12px;font-weight:900;padding:6px 10px;border-radius:999px;border:1px solid var(--line);white-space:nowrap}
    .tag.rec{color:var(--ok);border-color:rgba(22,163,74,.25);background:rgba(22,163,74,.07)}
    .tag.ok{color:var(--blue);border-color:rgba(37,99,235,.25);background:rgba(37,99,235,.07)}
    .tag.bad{color:var(--bad);border-color:rgba(220,38,38,.25);background:rgba(220,38,38,.07)}
    .small{font-size:12px}
    ul{margin:8px 0 0 18px;padding:0}

    .need{
      background:var(--needBg)!important;
      border-color:var(--needLine)!important;
      box-shadow:0 0 0 3px rgba(246,195,75,.18)
    }

    .note{
      margin-top:-6px;
      font-size:12px;
      color:var(--muted);
      padding:8px 10px;
      border:1px dashed rgba(15,23,42,.14);
      border-radius:12px;
      background:rgba(255,255,255,.65);
    }

    /* ===== Mobile: quebra antes de ‚Äúsumir‚Äù campo + agrupa 2 em 2 ===== */
    @media (max-width: 980px){
      thead{display:none}

      table, tbody{display:block;width:100%}
      tbody tr{
        display:grid;
        grid-template-columns: 1fr 120px;
        grid-template-areas:
          "carga pot"
          "qtd tempo"
          "cons pico"
          "acao acao";
        gap:8px;
        border:1px solid var(--line);
        border-radius:14px;
        margin:10px 0;
        padding:10px;
        background:#fff;
      }
      td{
        border:none;
        padding:0;
        overflow:visible;
      }
      td.right{text-align:left}

      /* r√≥tulo pequeno dentro do campo */
      td[data-label]::before{
        content: attr(data-label);
        display:block;
        color:var(--muted);
        font-weight:900;
        font-size:10px;
        margin:0 0 4px 2px;
      }

      .td-carga{grid-area:carga}
      .td-pot{grid-area:pot}
      .td-qtd{grid-area:qtd}
      .td-tempo{grid-area:tempo}
      .td-cons{grid-area:cons}
      .td-pico{grid-area:pico}
      .td-acao{grid-area:acao}

      .actionsRow{justify-content:flex-end}

      select, input[type="text"]{min-height:36px;padding:8px 10px}

      .totals{grid-template-columns:1fr;gap:8px}
      .k1,.k2,.k3,.u1{grid-column:span 12}
      .kpi,.cfg{min-height:auto}
      .pillRow{flex-wrap:wrap}
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="hero">
    <h1>Calculadora de Escolha de Esta√ß√µes de Energia Pecron</h1>
  </div>

  <div class="card">
    <div class="sectionTitle">Cargas</div>

    <div class="tableWrap">
      <table>
        <colgroup>
          <col class="c1"><col class="c2"><col class="c3"><col class="c4"><col class="c5"><col class="c6"><col class="c7">
        </colgroup>
        <thead>
          <tr>
            <th>Carga</th>
            <th class="right">Pot√™ncia (W)</th>
            <th class="right">Qtd</th>
            <th class="right">Tempo (h)</th>
            <th class="right">Consumo (Wh)</th>
            <th class="right">Pico total (W)</th>
            <th class="right">A√ß√£o</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="hr"></div>

    <div class="totals">
      <div class="kpi k1">
        <div class="t">Pot√™ncia total</div>
        <div class="v" id="kpiW">0 W</div>
      </div>
      <div class="kpi k2">
        <div class="t">Consumo total</div>
        <div class="v" id="kpiWh">0 Wh</div>
      </div>
      <div class="kpi k3">
        <div class="t">Pot√™ncia pico total</div>
        <div class="v" id="kpiPk">0 W</div>
      </div>

      <div class="cfg u1">
        <div class="title">Uso</div>
        <div class="pillRow">
          <label class="pill">
            <input type="radio" name="modo" value="S" checked>
            <span><b>Uso espor√°dico</b> <span class="muted">(DoD 90%)</span></span>
          </label>
          <label class="pill">
            <input type="radio" name="modo" value="D">
            <span><b>Uso di√°rio</b> <span class="muted">(DoD 80%)</span></span>
          </label>
        </div>
      </div>
    </div>

    <div id="msg" class="msg" style="display:none"></div>

    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:12px;flex-wrap:wrap">
      <button id="btnNovo" class="btnGhost">Novo C√°lculo</button>
      <button id="btnCalc" class="btn">Calcular</button>
    </div>
  </div>

  <div id="secDia" class="card" style="margin-top:12px;display:none">
    <div class="sectionTitle">Autonomia por dia</div>
    <div class="note">
      Considera o uso di√°rio das cargas pelos tempos informados em cada uma. A autonomia abaixo mostra por quantos dias esse padr√£o de uso pode ser repetido.
    </div>
    <div class="cards" id="cardsDia" style="margin-top:10px"></div>
  </div>

  <div id="secCont" class="card" style="margin-top:12px;display:none">
    <div class="sectionTitle">Autonomia cont√≠nua</div>
    <div class="note">
      Considera todas as cargas ligadas ao mesmo tempo, continuamente (ignorando os tempos). A autonomia abaixo indica por quanto tempo a esta√ß√£o sustenta esse conjunto at√© esgotar a bateria. M√≠nimo: 45 minutos.
    </div>
    <div class="cards" id="cardsCont" style="margin-top:10px"></div>
  </div>
</div>

<script>
const PRESETS = [
  {name:'L√¢mpada LED 9W', power:9, pico:1},
  {name:'Celular', power:30, pico:1},
  {name:'Notebook', power:60, pico:1},
  {name:'Drone', power:40, pico:1},
  {name:'Projetor', power:65, pico:1},
  {name:'Som', power:50, pico:1},
  {name:'Roteador e Modem', power:20, pico:1},
  {name:'Starlink Mini', power:24, pico:1},
  {name:'Ventilador', power:80, pico:4},
  {name:'Geladeira 300L', power:120, pico:5},
  {name:'Geladeira 350L', power:180, pico:5},
  {name:'Freezer 300L', power:180, pico:5},
  {name:'Geladeria Port√°til 30L', power:45, pico:5},
  {name:'Geladeria Port√°til 50L', power:70, pico:5},
  {name:"TV LED 42'", power:120, pico:1},
];

const MODELOS = [
  {name:'P500',  V:12.8, Ah:36, eff:0.85, contW:500,  peakW:700},
  {name:'E1000', V:51.2, Ah:20, eff:0.85, contW:1800, peakW:3000},
  {name:'E2400', V:51.2, Ah:40, eff:0.85, contW:2400, peakW:4000},
];

const DoD = { S: 0.9, D: 0.8 };
const MIN_CONT_MINUTES = 45;

const tbody = document.getElementById('tbody');
const btnCalc = document.getElementById('btnCalc');
const btnNovo = document.getElementById('btnNovo');

const kpiW = document.getElementById('kpiW');
const kpiWh = document.getElementById('kpiWh');
const kpiPk = document.getElementById('kpiPk');
const msg = document.getElementById('msg');

const secDia = document.getElementById('secDia');
const secCont = document.getElementById('secCont');
const cardsDia = document.getElementById('cardsDia');
const cardsCont = document.getElementById('cardsCont');

function fmt(n, dec=0){
  if (!isFinite(n)) return '‚Äî';
  return n.toLocaleString('pt-BR', {minimumFractionDigits:dec, maximumFractionDigits:dec});
}
function getModo(){ return document.querySelector('input[name="modo"]:checked').value; }

function showMsg(text, kind='bad'){
  msg.textContent = text;
  msg.className = 'msg ' + (kind === 'ok' ? 'ok' : 'bad');
  msg.style.display = 'block';
}
function hideMsg(){ msg.style.display = 'none'; msg.textContent = ''; }

function parseHorasBR(v){
  if (!v) return 0;
  const raw = String(v).trim();
  const s = raw.includes(',') ? raw.replace(/\./g,'').replace(',', '.') : raw;
  const n = parseFloat(s);
  return isFinite(n) && n > 0 ? n : 0;
}
function formatHorasBR(hours, dec=2){
  if (!isFinite(hours)) return '';
  let s = hours.toFixed(dec).replace('.', ',');
  s = s.replace(/,?0+$/,'').replace(/,$/,',0');
  return (s === '0' || s === '0,0') ? '' : s;
}
function parseQtd(v){
  if (!v) return 0;
  const s = String(v).trim().replace(/\D+/g,'');
  const n = parseInt(s || '0', 10);
  return isFinite(n) && n > 0 ? n : 0;
}
function floor5Minutes(mins){
  mins = Math.floor(Math.max(0, mins));
  return Math.floor(mins / 5) * 5;
}
function floor5MinutesFromHours(hours){
  const mins = Math.floor(Math.max(0, hours) * 60);
  return floor5Minutes(mins);
}
function plural(n, s, p){ return n === 1 ? s : p; }

function minutesToLongText(mins){
  mins = floor5Minutes(mins);
  const d = Math.floor(mins / (24*60));
  mins -= d*24*60;
  const h = Math.floor(mins / 60);
  const m = mins % 60;

  const parts = [];
  if (d > 0) parts.push(`${d} ${plural(d,'dia','dias')}`);
  if (h > 0) parts.push(`${h} ${plural(h,'hora','horas')}`);
  parts.push(`${m} ${plural(m,'minuto','minutos')}`);

  if (parts.length === 1) return parts[0];
  if (parts.length === 2) return parts[0] + ' e ' + parts[1];
  return parts[0] + ' ' + parts[1] + ' e ' + parts[2];
}

function buildPresetSelect(el){
  el.innerHTML = '';
  const opt0 = document.createElement('option');
  opt0.value = '';
  opt0.textContent = 'Selecione...';
  el.appendChild(opt0);
  for (let i=0;i<PRESETS.length;i++){
    const p = PRESETS[i];
    const opt = document.createElement('option');
    opt.value = String(i);
    opt.textContent = p.name;
    el.appendChild(opt);
  }
}

function modelEnergyNominalWh(m){ return m.V * m.Ah; }
function modelEnergyUsefulWh(m, modo){ return modelEnergyNominalWh(m) * m.eff * DoD[modo]; }

function rowIsValid(tr){
  const idxStr = tr.querySelector('.cargaSel').value;
  const qty = parseQtd(tr.querySelector('.qty').value || '');
  const horas = parseHorasBR(tr.querySelector('.horas').value || '');
  return idxStr !== '' && qty > 0 && horas > 0;
}

function refreshNeedHighlight(tr){
  const sel = tr.querySelector('.cargaSel');
  const qtyEl = tr.querySelector('.qty');
  const hEl = tr.querySelector('.horas');

  const hasCarga = (sel.value !== '');
  const qty = parseQtd(qtyEl.value || '');
  const horas = parseHorasBR(hEl.value || '');

  if (!hasCarga) sel.classList.add('need'); else sel.classList.remove('need');
  if (qty <= 0) qtyEl.classList.add('need'); else qtyEl.classList.remove('need');
  if (horas <= 0) hEl.classList.add('need'); else hEl.classList.remove('need');
}

function updateActionButtons(){
  const rows = Array.from(tbody.querySelectorAll('tr'));
  rows.forEach((tr, idx) => {
    const plus = tr.querySelector('.btnPlus');
    const isLast = idx === rows.length - 1;
    plus.style.visibility = isLast ? 'visible' : 'hidden';
    plus.disabled = !(isLast && rowIsValid(tr));
  });
}

function recalcPreviewTotals(){
  let totW = 0, totWh = 0, totPk = 0;

  const rows = Array.from(tbody.querySelectorAll('tr'));
  for (const tr of rows){
    const idxStr = tr.querySelector('.cargaSel').value;
    const p = idxStr === '' ? null : PRESETS[parseInt(idxStr,10)];
    const qty = parseQtd(tr.querySelector('.qty').value || '');
    const horas = parseHorasBR(tr.querySelector('.horas').value || '');

    refreshNeedHighlight(tr);

    const potEl = tr.querySelector('.pot');
    const consEl = tr.querySelector('.consumo');
    const picoEl = tr.querySelector('.picoTot');

    if (!p){
      potEl.textContent = '0';
      consEl.textContent = '0';
      picoEl.textContent = '0';
      continue;
    }

    potEl.textContent = fmt(p.power,0);

    if (qty <= 0 || horas <= 0){
      consEl.textContent = '0';
      picoEl.textContent = '0';
      continue;
    }

    const mins = floor5MinutesFromHours(horas);
    const horasAdj = mins / 60;

    const w = p.power * qty;
    const wh = w * horasAdj;
    const pk = w * p.pico;

    consEl.textContent = fmt(wh,0);
    picoEl.textContent = fmt(pk,0);

    totW += w; totWh += wh; totPk += pk;
  }

  kpiW.textContent = `${fmt(totW,0)} W`;
  kpiWh.textContent = `${fmt(totWh,0)} Wh`;
  kpiPk.textContent = `${fmt(totPk,0)} W`;

  updateActionButtons();
}

function makeRowBlank(){
  const tr = document.createElement('tr');

  tr.innerHTML = `
    <td class="td-carga" data-label="Carga"><select class="cargaSel need"></select></td>
    <td class="td-pot right" data-label="Pot√™ncia (W)"><span class="pot">0</span></td>
    <td class="td-qtd right" data-label="Qtd"><input class="qty need" type="text" inputmode="numeric" value=""></td>
    <td class="td-tempo right" data-label="Tempo (h)"><input class="horas need" type="text" inputmode="decimal" value=""></td>
    <td class="td-cons right" data-label="Consumo (Wh)"><span class="consumo">0</span></td>
    <td class="td-pico right" data-label="Pico total (W)"><span class="picoTot">0</span></td>
    <td class="td-acao right" data-label="A√ß√£o">
      <div class="actionsRow">
        <button class="iconBtn btnPlus" title="Adicionar nova linha">Ôºã</button>
        <button class="iconBtn btnDel" title="Remover linha">üóë</button>
      </div>
    </td>
  `;

  const sel = tr.querySelector('.cargaSel');
  const qty = tr.querySelector('.qty');
  const horas = tr.querySelector('.horas');
  const btnPlus = tr.querySelector('.btnPlus');
  const btnDel = tr.querySelector('.btnDel');

  buildPresetSelect(sel);

  sel.addEventListener('change', () => { hideMsg(); recalcPreviewTotals(); });

  qty.addEventListener('input', () => {
    hideMsg();
    const cleaned = String(qty.value || '').replace(/\D+/g,'');
    if (qty.value !== cleaned) qty.value = cleaned;
    recalcPreviewTotals();
  });

  horas.addEventListener('input', () => {
    hideMsg();
    const cleaned = String(horas.value || '').replace(/[^0-9,\.]/g,'');
    if (horas.value !== cleaned) horas.value = cleaned;
    recalcPreviewTotals();
  });

  horas.addEventListener('blur', () => {
    const h = parseHorasBR(horas.value || '');
    const mins = floor5MinutesFromHours(h);
    const hAdj = mins / 60;
    horas.value = hAdj > 0 ? formatHorasBR(hAdj, 2) : '';
    hideMsg();
    recalcPreviewTotals();
  });

  btnPlus.addEventListener('click', () => {
    hideMsg();
    const rows = Array.from(tbody.querySelectorAll('tr'));
    if (rows[rows.length - 1] !== tr) return;
    if (!rowIsValid(tr)){
      showMsg('Preencha carga, Qtd e Tempo (h) antes de adicionar nova linha.');
      return;
    }
    tbody.appendChild(makeRowBlank());
    recalcPreviewTotals();
  });

  btnDel.addEventListener('click', () => {
    tr.remove();
    hideMsg();
    recalcPreviewTotals();
    if (tbody.querySelectorAll('tr').length === 0){
      tbody.appendChild(makeRowBlank());
      recalcPreviewTotals();
    }
  });

  return tr;
}

function collectRowsValidated(){
  const rows = Array.from(tbody.querySelectorAll('tr'));
  const items = [];

  for (let i=0;i<rows.length;i++){
    const tr = rows[i];
    const idxStr = tr.querySelector('.cargaSel').value;
    const qty = parseQtd(tr.querySelector('.qty').value || '');
    const h = parseHorasBR(tr.querySelector('.horas').value || '');

    const isBlank = (idxStr === '' && qty <= 0 && h <= 0);
    const isValid = (idxStr !== '' && qty > 0 && h > 0);
    const isPartial = !isBlank && !isValid;

    if (isPartial) return { ok:false, error:`Linha ${i+1} incompleta: selecione a carga e preencha Qtd e Tempo (h).` };

    if (isBlank){
      for (let j=i+1;j<rows.length;j++){
        const tr2 = rows[j];
        const idx2 = tr2.querySelector('.cargaSel').value;
        const q2 = parseQtd(tr2.querySelector('.qty').value || '');
        const h2 = parseHorasBR(tr2.querySelector('.horas').value || '');
        if (idx2 !== '' || q2 > 0 || h2 > 0) return { ok:false, error:`H√° uma linha preenchida ap√≥s uma linha em branco (linha ${j+1}).` };
      }
      break;
    }

    const p = PRESETS[parseInt(idxStr,10)];
    const mins = floor5MinutesFromHours(h);
    const horasAdj = mins / 60;

    tr.querySelector('.horas').value = horasAdj > 0 ? formatHorasBR(horasAdj, 2) : '';
    tr.querySelector('.qty').value = String(qty);

    const w  = p.power * qty;
    const wh = w * horasAdj;
    const pk = w * p.pico;

    items.push({ name:p.name, power:p.power, pico:p.pico, qty, horas:horasAdj, w, wh, pk });
  }

  if (items.length === 0) return { ok:false, error:'Adicione ao menos uma carga.' };
  return { ok:true, items };
}

function calcTotals(items){
  let totW = 0, totWh = 0, totPk = 0;
  for (const it of items){
    totW += it.w;
    totWh += it.wh;
    totPk += it.pk;
  }
  return { totW, totWh, totPk };
}

function renderCards(container, results){
  container.innerHTML = '';
  for (const r of results){
    const div = document.createElement('div');
    div.className = 'mcard';

    const tagClass = r.recommended ? 'rec' : (r.compat ? 'ok' : 'bad');
    const tagText  = r.recommended ? 'Recomendado' : (r.compat ? 'Compat√≠vel' : 'N√£o compat√≠vel');

    div.innerHTML = `
      <div class="mhead">
        <div style="font-weight:900;font-size:14px">${r.name}</div>
        <span class="tag ${tagClass}">${tagText}</span>
      </div>
      <div class="small muted">
        Pot√™ncia: ${fmt(r.contW,0)} W ‚Ä¢ Pico: ${fmt(r.peakW,0)} W ‚Ä¢ Energia: ${fmt(r.energyNominalWh,0)} Wh
      </div>
      <div class="small" style="margin-top:8px">
        <div><span class="muted">Autonomia:</span> <b>${r.compat ? r.autonomyText : '‚Äî'}</b></div>
      </div>
    `;

    if (!r.compat){
      const ul = document.createElement('ul');
      for (const reason of r.reasons){
        const li = document.createElement('li');
        li.textContent = reason;
        ul.appendChild(li);
      }
      div.appendChild(ul);
    }

    container.appendChild(div);
  }
}

function markRecommendedSmallestCompatible(results){
  const compatibles = results.filter(x => x.compat);
  if (!compatibles.length) return results;

  compatibles.sort((a,b) => (a.energyNominalWh - b.energyNominalWh) || (a.contW - b.contW));
  const recName = compatibles[0].name;

  return results.map(x => ({...x, recommended: (x.compat && x.name === recName)}));
}

function novoCalculo(){
  hideMsg();
  secDia.style.display = 'none';
  secCont.style.display = 'none';
  cardsDia.innerHTML = '';
  cardsCont.innerHTML = '';
  tbody.innerHTML = '';
  tbody.appendChild(makeRowBlank());
  recalcPreviewTotals();
  window.scrollTo({top:0, behavior:'smooth'});
}

btnCalc.addEventListener('click', () => {
  hideMsg();

  const got = collectRowsValidated();
  if (!got.ok){
    showMsg(got.error, 'bad');
    secDia.style.display = 'none';
    secCont.style.display = 'none';
    return;
  }

  const modo = getModo();
  const totals = calcTotals(got.items);

  const resDiaRaw = MODELOS.map(m => {
    const energyNominalWh = (m.V * m.Ah);
    const energyUsefulWh  = energyNominalWh * m.eff * DoD[modo];

    const passW  = totals.totW  <= m.contW + 1e-9;
    const passPk = totals.totPk <= m.peakW + 1e-9;
    const passE  = totals.totWh <= energyUsefulWh + 1e-9;

    const compat = passW && passPk && passE;

    const reasons = [];
    if (!passW)  reasons.push(`Excede pot√™ncia em ${fmt(totals.totW - m.contW,0)} W`);
    if (!passPk) reasons.push(`Excede pico em ${fmt(totals.totPk - m.peakW,0)} W`);
    if (!passE)  reasons.push(`Energia insuficiente: falta ${fmt(totals.totWh - energyUsefulWh,0)} Wh`);

    let autonomyText = '';
    if (compat){
      const days = (totals.totWh > 0) ? (energyUsefulWh / totals.totWh) : Infinity;
      const minutes = isFinite(days) ? (days * 24 * 60) : 999999999;
      autonomyText = (totals.totWh <= 0) ? '‚àû' : minutesToLongText(minutes);
    }

    return { name:m.name, contW:m.contW, peakW:m.peakW, energyNominalWh, compat, reasons, autonomyText, recommended:false };
  });
  const resDia = markRecommendedSmallestCompatible(resDiaRaw);

  const resContRaw = MODELOS.map(m => {
    const energyNominalWh = (m.V * m.Ah);
    const energyUsefulWh  = energyNominalWh * m.eff * DoD[modo];

    const passW  = totals.totW  <= m.contW + 1e-9;
    const passPk = totals.totPk <= m.peakW + 1e-9;

    let contMinutes = 0;
    if (totals.totW > 0){
      contMinutes = (energyUsefulWh / totals.totW) * 60;
    }

    const passMin = contMinutes >= MIN_CONT_MINUTES - 1e-9;
    const compat = passW && passPk && passMin;

    const reasons = [];
    if (!passW)   reasons.push(`Excede pot√™ncia em ${fmt(totals.totW - m.contW,0)} W`);
    if (!passPk)  reasons.push(`Excede pico em ${fmt(totals.totPk - m.peakW,0)} W`);
    if (!passMin) reasons.push(`Autonomia cont√≠nua menor que ${MIN_CONT_MINUTES} minutos`);

    let autonomyText = '';
    if (compat){
      autonomyText = minutesToLongText(contMinutes);
    }

    return { name:m.name, contW:m.contW, peakW:m.peakW, energyNominalWh, compat, reasons, autonomyText, recommended:false };
  });
  const resCont = markRecommendedSmallestCompatible(resContRaw);

  secDia.style.display = 'block';
  secCont.style.display = 'block';
  renderCards(cardsDia, resDia);
  renderCards(cardsCont, resCont);

  const anyDia = resDia.some(x => x.compat);
  const anyCont = resCont.some(x => x.compat);
  if (!anyDia && !anyCont) showMsg('Nenhum modelo ficou compat√≠vel (em nenhum crit√©rio).', 'bad');
  else showMsg('C√°lculo conclu√≠do.', 'ok');
});

btnNovo.addEventListener('click', novoCalculo);

function init(){
  tbody.innerHTML = '';
  tbody.appendChild(makeRowBlank());
  recalcPreviewTotals();
}
init();
</script>
</body>
</html>
